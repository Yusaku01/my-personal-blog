---
import { getCollection } from 'astro:content';
import { Fragment } from 'astro/jsx-runtime';
import Layout from '@/features/layout/layouts/SiteLayout.astro';
import { BlogControls } from '@/features/blog/components';
import HeroSection from '@/features/shared/components/Hero/HeroSection.astro';
import { getQiitaPosts } from '@/features/blog/api/qiita';
import { getZennPosts } from '@/features/blog/api/zenn';

const posts = await getCollection('blog');
const qiitaPosts = await getQiitaPosts('ngtnysk');
const zennPosts = await getZennPosts('saku2323');

const allPosts = [
  ...posts.map((post) => ({
    title: post.data.title,
    url: `/blog/${post.slug}`,
    publishDate: post.data.publishDate,
    excerpt: post.data.description,
    thumbnail: post.data.image,
    isExternal: false as const,
    platform: 'blog' as const,
    tags: post.data.tags || [],
  })),
  ...qiitaPosts,
  ...zennPosts,
];

const sortedPosts = [...allPosts].sort(
  (a, b) => new Date(b.publishDate).getTime() - new Date(a.publishDate).getTime()
);
const primaryThumbnail = sortedPosts.find((post) => Boolean(post.thumbnail))?.thumbnail;
---

<Layout title="BLOG | SAKUSPACE">
  <Fragment slot="head">
    {
      primaryThumbnail && (
        <link
          rel="preload"
          as="image"
          href={primaryThumbnail}
          imagesizes="(max-width: 640px) 100vw, (max-width: 1024px) 50vw, 25vw"
          fetchpriority="high"
          crossorigin="anonymous"
        />
      )
    }
  </Fragment>
  <HeroSection title="BLOG" isHome={false} />
  <div class="container-lg container-lg py-14">
    <BlogControls client:load posts={allPosts} />
  </div>
</Layout>
